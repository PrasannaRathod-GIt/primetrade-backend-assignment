<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #f4f6f9;
      color: #222;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .card {
      background: white;
      padding: 22px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 28px;
    }

    h3 {
      margin-top: 0;
    }

    #status {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .muted {
      color: #666;
      font-size: 14px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s ease;
    }

    button:hover {
      opacity: 0.9;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-light {
      background: #e5e7eb;
    }

    form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    input {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      min-width: 200px;
    }

    ul {
      padding-left: 0;
      list-style: none;
      margin: 0;
    }

    li {
      background: #fafafa;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #eee;
    }

    .item-left {
      flex: 1;
    }

    .item-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .meta {
      font-size: 13px;
      color: #666;
    }

    .controls button {
      margin-left: 8px;
    }

  </style>
</head>

<body>
  <div class="container">

    <div class="top-bar">
      <h1>Dashboard</h1>
      <button id="logout" class="btn-light">Log out</button>
    </div>

    <div class="card">
      <div id="status">Loading...</div>
      <div class="muted" id="roleHint"></div>
    </div>

    <div class="card">
      <h3>Create Item</h3>
      <form id="createForm">
        <input id="title" placeholder="Title" required />
        <input id="description" placeholder="Description (optional)" />
        <button type="submit" class="btn-primary">Create</button>
      </form>
    </div>

    <div class="card">
      <h3>Items</h3>
      <ul id="items"></ul>
    </div>

  </div>

<script>
/* ===== YOUR ORIGINAL LOGIC (UNCHANGED) ===== */

const BASE_URL = 'http://localhost:8000';
const ME_PATH = '/api/v1/auth/me';
const ITEMS_BASE = '/api/v1/items/';
const TOKEN_KEY = 'token';

let me = null;
let items = [];

function getToken() { return localStorage.getItem(TOKEN_KEY); }
function setStatus(txt) { document.getElementById('status').innerText = txt; }
function setRoleHint(txt) { document.getElementById('roleHint').innerText = txt; }

async function fetchJson(url, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers['Content-Type'] = 'application/json';
  const token = getToken();
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(url, opts);
  const body = await res.json().catch(()=>null);
  if (!res.ok) throw body || { detail: 'Unknown error', status: res.status };
  return body;
}

async function loadMe() {
  const token = getToken();
  if (!token) {
    setStatus('Not logged in â€” redirecting...');
    setTimeout(()=> location.href = 'login.html', 800);
    return;
  }
  try {
    me = await fetchJson(BASE_URL + ME_PATH);
    setStatus(`Logged in as: ${me.email} (${me.role})`);
    setRoleHint(`Full name: ${me.full_name || '-'}`);
  } catch {
    localStorage.removeItem(TOKEN_KEY);
    location.href = 'login.html';
  }
}

async function loadItems() {
  const res = await fetch(BASE_URL + ITEMS_BASE);
  items = await res.json();
  renderItems();
}

function renderItems() {
  const ul = document.getElementById('items');
  ul.innerHTML = '';
  if (!items.length) {
    ul.innerHTML = '<li>No items yet.</li>';
    return;
  }

  items.forEach(item => {
    const li = document.createElement('li');

    const left = document.createElement('div');
    left.className = 'item-left';
    left.innerHTML = `
      <div class="item-title">${escapeHtml(item.title)}</div>
      <div class="meta">${escapeHtml(item.description || '')}</div>
      <div class="meta">Owner ID: ${item.owner_id}</div>
    `;

    const right = document.createElement('div');
    right.className = 'controls';

    const canEdit = (item.owner_id === me?.id) || (me?.role === 'admin');
    const canDelete = (me?.role === 'admin');

    if (canEdit) {
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.className = 'btn-primary';
      editBtn.onclick = () => onEdit(item.id);
      right.appendChild(editBtn);
    }

    if (canDelete) {
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.className = 'btn-danger';
      delBtn.onclick = () => onDelete(item.id);
      right.appendChild(delBtn);
    }

    li.appendChild(left);
    li.appendChild(right);
    ul.appendChild(li);
  });
}

document.getElementById('createForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  if (!title) return alert('Title required');
  await fetchJson(BASE_URL + ITEMS_BASE, {
    method: 'POST',
    body: JSON.stringify({ title, description })
  });
  e.target.reset();
  await loadItems();
});

async function onEdit(id) {
  const newTitle = prompt('New title');
  if (!newTitle) return;
  await fetchJson(BASE_URL + ITEMS_BASE + id, {
    method: 'PUT',
    body: JSON.stringify({ title: newTitle })
  });
  await loadItems();
}

async function onDelete(id) {
  if (!confirm('Delete item?')) return;
  await fetchJson(BASE_URL + ITEMS_BASE + id, { method: 'DELETE' });
  await loadItems();
}

document.getElementById('logout').onclick = () => {
  localStorage.removeItem(TOKEN_KEY);
  location.href = 'login.html';
};

function escapeHtml(s) {
  return s?.replace(/[&<>"'`=\/]/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c])
  );
}

(async function init() {
  await loadMe();
  await loadItems();
})();
</script>
</body>
</html>
